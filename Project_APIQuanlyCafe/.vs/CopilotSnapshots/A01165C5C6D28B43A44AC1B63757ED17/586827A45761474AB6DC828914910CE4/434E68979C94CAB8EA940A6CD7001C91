using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using Microsoft.Extensions.Configuration;
using Models;

namespace DAL
{
    public class OrderDAL
    {
        private readonly DatabaseHelper _dbHelper;
        
        public OrderDAL(DatabaseHelper dbHelper)
        {
            _dbHelper = dbHelper;
        }
        
        // Lấy danh sách tất cả đơn hàng
        public List<OrderModel> GetAllOrders()
        {
            List<OrderModel> orders = new List<OrderModel>();
            
            string query = "SELECT * FROM HoaDonBan ORDER BY thoiDiemVao DESC";
            DataTable dt = _dbHelper.ExecuteQuery(query);
            
            foreach (DataRow row in dt.Rows)
            {
                OrderModel order = new OrderModel
                {
                    Id = Convert.ToInt32(row["id"]),
                    ThoiDiemVao = Convert.ToDateTime(row["thoiDiemVao"]),
                    ThoiDiemRa = row["thoiDiemRa"] as DateTime?,
                    IdBanAn = Convert.ToInt32(row["idBanAn"]),
                    TrangThaiHD = Convert.ToInt32(row["trangThaiHD"]),
                    IdNhanVien = row["idNhanVien"] as int?
                };
                orders.Add(order);
            }
            
            return orders;
        }
        
        // Lấy đơn hàng theo ID
        public OrderModel GetOrderById(int id)
        {
            OrderModel order = null;
            
            string query = "SELECT * FROM HoaDonBan WHERE id = @id";
            SqlParameter[] parameters = { new SqlParameter("@id", id) };
            DataTable dt = _dbHelper.ExecuteQuery(query, parameters);
            
            if (dt.Rows.Count > 0)
            {
                DataRow row = dt.Rows[0];
                order = new OrderModel
                {
                    Id = Convert.ToInt32(row["id"]),
                    ThoiDiemVao = Convert.ToDateTime(row["thoiDiemVao"]),
                    ThoiDiemRa = row["thoiDiemRa"] as DateTime?,
                    IdBanAn = Convert.ToInt32(row["idBanAn"]),
                    TrangThaiHD = Convert.ToInt32(row["trangThaiHD"]),
                    IdNhanVien = row["idNhanVien"] as int?
                };
            }
            
            // Lấy chi tiết đơn hàng nếu tồn tại
            if (order != null)
            {
                order.DetailOrders = GetDetailOrdersByOrderId(id);
            }
            
            return order;
        }
        
        // Lấy chi tiết đơn hàng
        public List<DetailOrderModel> GetDetailOrdersByOrderId(int orderId)
        {
            List<DetailOrderModel> details = new List<DetailOrderModel>();
            
            string query = "SELECT * FROM ChiTietHoaDonBan WHERE idHoaDonBan = @orderId";
            SqlParameter[] parameters = { new SqlParameter("@orderId", orderId) };
            DataTable dt = _dbHelper.ExecuteQuery(query, parameters);
            
            foreach (DataRow row in dt.Rows)
            {
                DetailOrderModel detail = new DetailOrderModel
                {
                    Id = Convert.ToInt32(row["id"]),
                    IdHoaDonBan = Convert.ToInt32(row["idHoaDonBan"]),
                    IdMonAn = Convert.ToInt32(row["idMonAn"]),
                    SoLuong = Convert.ToInt32(row["soLuong"])
                };
                details.Add(detail);
            }
            
            return details;
        }
        
        // Tạo đơn hàng mới
        public int CreateOrder(CreateOrderRequest request)
        {
            using (var conn = _dbHelper.GetConnection())
            {
                conn.Open();
                SqlTransaction transaction = conn.BeginTransaction();
                
                try
                {
                    // Kiểm tra bàn ăn có tồn tại không
                    string checkTableQuery = "SELECT COUNT(1) FROM Ban WHERE id = @idBanAn";
                    SqlParameter[] checkParams = { new SqlParameter("@idBanAn", request.IdBanAn) };
                    
                    using (var checkCmd = new SqlCommand(checkTableQuery, conn, transaction))
                    {
                        checkCmd.Parameters.AddRange(checkParams);
                        int tableExists = (int)checkCmd.ExecuteScalar();
                        if (tableExists == 0)
                        {
                            throw new Exception($"Bàn ăn với ID {request.IdBanAn} không tồn tại trong hệ thống");
                        }
                    }
                    
                    // Tạo đơn hàng
                    string orderQuery = @"INSERT INTO HoaDonBan (thoiDiemVao, idBanAn, trangThaiHD, idNhanVien) 
                                         VALUES (@thoiDiemVao, @idBanAn, @trangThaiHD, @idNhanVien)";
                    
                    SqlParameter[] orderParams = {
                        new SqlParameter("@thoiDiemVao", DateTime.Now),
                        new SqlParameter("@idBanAn", request.IdBanAn),
                        new SqlParameter("@trangThaiHD", 0),
                        new SqlParameter("@idNhanVien", (object)request.IdNhanVien ?? DBNull.Value)
                    };
                    
                    int orderId = _dbHelper.ExecuteInsertAndGetId(orderQuery, orderParams);
                    
                    // Tạo chi tiết đơn hàng
                    foreach (var detail in request.DetailOrders)
                    {
                        string detailQuery = @"INSERT INTO ChiTietHoaDonBan (idHoaDonBan, idMonAn, soLieu) 
                                              VALUES (@idHoaDonBan, @idMonAn, @soLieu)";
                        
                        SqlParameter[] detailParams = {
                            new SqlParameter("@idHoaDonBan", orderId),
                            new SqlParameter("@idMonAn", detail.IdMonAn),
                            new SqlParameter("@soLieu", detail.SoLuong)
                        };
                        
                        _dbHelper.ExecuteNonQuery(detailQuery, detailParams);
                    }
                    
                    transaction.Commit();
                    return orderId;
                }
                catch
                {
                    transaction.Rollback();
                    throw;
                }
            }
        }
        
        // Cập nhật đơn hàng
        public bool UpdateOrder(int id, UpdateOrderRequest request)
        {
            using (var conn = _dbHelper.GetConnection())
            {
                conn.Open();
                SqlTransaction transaction = conn.BeginTransaction();
                
                try
                {
                    // Cập nhật thông tin đơn hàng
                    string orderQuery = @"UPDATE HoaDonBan 
                                         SET thoiDiemRa = @thoiDiemRa, idNhanVien = @idNhanVien 
                                         WHERE id = @id";
                    
                    SqlParameter[] orderParams = {
                        new SqlParameter("@id", id),
                        new SqlParameter("@thoiDiemRa", (object)request.ThoiDiemRa ?? DBNull.Value),
                        new SqlParameter("@idNhanVien", (object)request.IdNhanVien ?? DBNull.Value)
                    };
                    
                    int rowsAffected;
                    using (var orderCmd = new SqlCommand(orderQuery, conn, transaction))
                    {
                        orderCmd.Parameters.AddRange(orderParams);
                        rowsAffected = orderCmd.ExecuteNonQuery();
                    }
                    
                    if (rowsAffected > 0 && request.DetailOrders.Count > 0)
                    {
                        // Xóa chi tiết đơn hàng cũ
                        string deleteDetailQuery = "DELETE FROM ChiTietHoaDonBan WHERE idHoaDonBan = @id";
                        SqlParameter[] deleteParams = { new SqlParameter("@id", id) };
                        
                        using (var deleteCmd = new SqlCommand(deleteDetailQuery, conn, transaction))
                        {
                            deleteCmd.Parameters.AddRange(deleteParams);
                            deleteCmd.ExecuteNonQuery();
                        }
                        
                        // Thêm chi tiết đơn hàng mới
                        foreach (var detail in request.DetailOrders)
                        {
                            string detailQuery = @"INSERT INTO ChiTietHoaDonBan (idHoaDonBan, idMonAn, soLieu) 
                                                  VALUES (@idHoaDonBan, @idMonAn, @soLieu)";
                            
                            SqlParameter[] detailParams = {
                                new SqlParameter("@idHoaDonBan", id),
                                new SqlParameter("@idMonAn", detail.IdMonAn),
                                new SqlParameter("@soLieu", detail.SoLuong)
                            };
                            
                            using (var detailCmd = new SqlCommand(detailQuery, conn, transaction))
                            {
                                detailCmd.Parameters.AddRange(detailParams);
                                detailCmd.ExecuteNonQuery();
                            }
                        }
                    }
                    
                    transaction.Commit();
                    return rowsAffected > 0;
                }
                catch
                {
                    transaction.Rollback();
                    throw;
                }
            }
        }
        
        // Xóa đơn hàng
        public bool DeleteOrder(int id)
        {
            using (var conn = _dbHelper.GetConnection())
            {
                conn.Open();
                SqlTransaction transaction = conn.BeginTransaction();
                
                try
                {
                    // Xóa chi tiết đơn hàng trước
                    string deleteDetailQuery = "DELETE FROM ChiTietHoaDonBan WHERE idHoaDonBan = @id";
                    SqlParameter[] deleteDetailParams = { new SqlParameter("@id", id) };
                    
                    using (var deleteDetailCmd = new SqlCommand(deleteDetailQuery, conn, transaction))
                    {
                        deleteDetailCmd.Parameters.AddRange(deleteDetailParams);
                        deleteDetailCmd.ExecuteNonQuery();
                    }
                    
                    // Xóa đơn hàng
                    string deleteOrderQuery = "DELETE FROM HoaDonBan WHERE id = @id";
                    SqlParameter[] deleteOrderParams = { new SqlParameter("@id", id) };
                    
                    int rowsAffected;
                    using (var deleteOrderCmd = new SqlCommand(deleteOrderQuery, conn, transaction))
                    {
                        deleteOrderCmd.Parameters.AddRange(deleteOrderParams);
                        rowsAffected = deleteOrderCmd.ExecuteNonQuery();
                    }
                    
                    transaction.Commit();
                    return rowsAffected > 0;
                }
                catch
                {
                    transaction.Rollback();
                    throw;
                }
            }
        }
        
        // Cập nhật trạng thái đơn hàng
        public bool UpdateOrderStatus(int id, UpdateOrderStatusRequest request)
        {
            string query = @"UPDATE HoaDonBan 
                            SET trangThaiHD = @trangThaiHD, thoiDiemRa = @thoiDiemRa 
                            WHERE id = @id";
            
            SqlParameter[] parameters = {
                new SqlParameter("@id", id),
                new SqlParameter("@trangThaiHD", request.TrangThaiHD),
                new SqlParameter("@thoiDiemRa", (object)request.ThoiDiemRa ?? DBNull.Value)
            };
            
            int rowsAffected = _dbHelper.ExecuteNonQuery(query, parameters);
            return rowsAffected > 0;
        }
        
        // Lấy đơn hàng theo bàn
        public List<OrderModel> GetOrdersByTableId(int tableId)
        {
            List<OrderModel> orders = new List<OrderModel>();
            
            string query = "SELECT * FROM HoaDonBan WHERE idBanAn = @tableId ORDER BY thoiDiemVao DESC";
            SqlParameter[] parameters = { new SqlParameter("@tableId", tableId) };
            DataTable dt = _dbHelper.ExecuteQuery(query, parameters);
            
            foreach (DataRow row in dt.Rows)
            {
                OrderModel order = new OrderModel
                {
                    Id = Convert.ToInt32(row["id"]),
                    ThoiDiemVao = Convert.ToDateTime(row["thoiDiemVao"]),
                    ThoiDiemRa = row["thoiDiemRa"] as DateTime?,
                    IdBanAn = Convert.ToInt32(row["idBanAn"]),
                    TrangThaiHD = Convert.ToInt32(row["trangThaiHD"]),
                    IdNhanVien = row["idNhanVien"] as int?
                };
                orders.Add(order);
            }
            
            return orders;
        }
    }
}
