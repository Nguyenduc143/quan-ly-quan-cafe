<!-- =======================================================
    QUẢN LÝ GIẢNG VIÊN - Kèm phân môn giảng dạy
    ======================================================= -->
<div class="admin-layout">
    <!-- Sidebar -->
    <app-sidebar></app-sidebar>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">
                    Quản lý Giảng viên
                </h1>
            </div>
            
            <div class="header-right">
                <notification-bell></notification-bell>
                <div class="user-info" ng-init="currentUser = getCurrentUser()">
                    <div class="user-avatar" ng-click="openAvatarModal()">
                        <img ng-if="currentUser.avatarUrl" ng-src="{{currentUser.avatarUrl}}" alt="Avatar">
                        <span ng-if="!currentUser.avatarUrl">{{currentUser.fullName ? currentUser.fullName.charAt(0) : 'U'}}</span>
                    </div>
                    <div class="user-details">
                        <span class="user-name">{{currentUser.fullName}}</span>
                        <span class="user-role">{{currentUser.roleName || 'Admin'}}</span>
                    </div>
                </div>
                <button ng-click="logout()" class="btn btn-outline">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </header>
        
        <!-- Content Body -->
        <div class="content-body">
            <div class="container-fluid">
            <!-- Tab Navigation - Custom Design -->
            <div class="custom-tabs">
                <div class="custom-tab-nav">
                    <button class="custom-tab-button" 
                            ng-class="{'active': activeTab === 'lecturers'}" 
                            ng-click="onTabClick('lecturers')">
                        <i class="fas fa-users"></i> Danh sách Giảng viên
                    </button>
                    <!-- Chỉ hiện tab Phân môn nếu có quyền -->
                    <button ng-if="canViewSubjectAssignment" 
                            class="custom-tab-button" 
                            ng-class="{'active': activeTab === 'subjects'}" 
                            ng-click="onTabClick('subjects')">
                        <i class="fas fa-book"></i> Phân môn giảng dạy
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="custom-tab-content">
                <!-- ===========================
                     TAB 1: DANH SÁCH GIẢNG VIÊN
                     =========================== -->
                <div id="tab-lecturers" class="custom-tab-panel" ng-show="activeTab === 'lecturers'">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-users"></i> Danh sách Giảng viên
                            </h3>
                            <div class="card-tools">
                                <select class="form-control form-control-sm d-inline-block" style="width: 220px;" 
                                        ng-model="filterByDepartment" ng-change="loadLecturersByDepartment()">
                                    <option value="">-- Tất cả Bộ môn --</option>
                                    <option ng-repeat="d in departments" value="{{d.departmentId}}">
                                        {{d.departmentName}} ({{d.facultyName}})
                                    </option>
                                </select>
                                <button class="btn btn-primary btn-sm ml-2" ng-click="openLecturerModal()">
                                    <i class="fas fa-plus"></i> Thêm Giảng viên
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th style="width: 50px;">#</th>
                                            <th>Họ tên</th>
                                            <th style="width: 150px;">Học hàm/Học vị</th>
                                            <th style="width: 200px;">Bộ môn</th>
                                            <th ng-if="canViewSubjectAssignment" style="width: 120px;">Số môn dạy</th>
                                            <th style="width: 150px;">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="lecturer in lecturers">
                                            <td>{{$index + 1}}</td>
                                            <td>
                                                <strong>{{lecturer.fullName}}</strong>
                                                <br>
                                                <small class="text-muted">
                                                    <i class="fas fa-envelope"></i> {{lecturer.email}}
                                                </small>
                                            </td>
                                            <td>
                                                <span class="badge badge-info" ng-if="lecturer.academicTitle">
                                                    {{lecturer.academicTitle}}
                                                </span>
                                                <span class="badge badge-secondary" ng-if="lecturer.degree">
                                                    {{lecturer.degree}}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge badge-primary">
                                                    {{lecturer.departmentName}}
                                                </span>
                                            </td>
                                            <td ng-if="canViewSubjectAssignment" class="text-center">
                                                <span class="badge badge-success" style="font-size: 14px;">
                                                    {{lecturer.subjectCount || 0}} môn
                                                </span>
                                                <br>
                                                <a href="javascript:void(0)" 
                                                   ng-click="viewLecturerSubjects(lecturer)" 
                                                   class="view-detail-link">
                                                    <i class="fas fa-eye"></i>
                                                    <span>Xem chi tiết</span>
                                                </a>
                                            </td>
                                            <td>
                                                <button ng-if="canViewSubjectAssignment" 
                                                        class="btn btn-sm btn-info" ng-click="assignSubjects(lecturer)"
                                                        title="Phân môn">
                                                    <i class="fas fa-book"></i>
                                                </button>
                                                <button class="btn btn-sm btn-warning" ng-click="editLecturer(lecturer)"
                                                        title="Sửa">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" ng-click="deleteLecturer(lecturer.lecturerId)"
                                                        title="Xóa">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr ng-if="lecturers.length === 0">
                                            <td ng-attr-colspan="{{canViewSubjectAssignment ? 6 : 5}}" 
                                                class="text-center text-muted">Chưa có dữ liệu</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===========================
                     TAB 2: PHÂN MÔN GIẢNG DẠY
                     =========================== -->
                <div id="tab-subjects" class="custom-tab-panel" ng-show="activeTab === 'subjects'">
                    <!-- Access Denied Message -->
                    <div ng-if="!canViewSubjectAssignment" class="card">
                        <div class="card-body text-center" style="padding: 60px 20px;">
                            <i class="fas fa-lock" style="font-size: 64px; color: #ef4444; margin-bottom: 20px;"></i>
                            <h3 style="color: #dc2626; margin-bottom: 10px;">Không có quyền truy cập</h3>
                            <p style="color: #64748b; font-size: 16px;">
                                Bạn không có quyền xem phân môn giảng dạy. 
                                <br>Vui lòng liên hệ quản trị viên nếu cần truy cập.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Content (Only shown if has permission) -->
                    <div ng-if="canViewSubjectAssignment" class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-book"></i> Tổng quan phân môn giảng dạy
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Hiển thị tổng quan các môn học và giảng viên được phân công
                                <span class="float-right">
                                    <strong>Tổng số: {{allSubjects.length}} môn học</strong>
                                </span>
                            </div>

                            <div ng-repeat="subject in paginatedSubjects" class="mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">
                                            <i class="fas fa-book"></i> 
                                            <strong>{{subject.subjectCode}}</strong> - {{subject.subjectName}}
                                            <span class="badge badge-secondary float-right">
                                                {{subject.credits}} tín chỉ
                                            </span>
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div ng-if="subject.assignedLecturers && subject.assignedLecturers.length > 0">
                                            <p class="text-muted mb-2">
                                                <i class="fas fa-users"></i> 
                                                Giảng viên được phân công ({{subject.assignedLecturers.length}}):
                                            </p>
                                            <div class="row">
                                                <div class="col-md-6 mb-2" ng-repeat="lecturer in subject.assignedLecturers">
                                                    <div class="d-flex align-items-center">
                                                        <span class="badge badge-success mr-2" ng-if="lecturer.isPrimary">
                                                            Chủ nhiệm
                                                        </span>
                                                        <span>{{lecturer.lecturerName}}</span>
                                                        <small class="text-muted ml-2" ng-if="lecturer.experienceYears">
                                                            ({{lecturer.experienceYears}} năm kinh nghiệm)
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div ng-if="!subject.assignedLecturers || subject.assignedLecturers.length === 0">
                                            <p class="text-warning">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                Chưa có giảng viên được phân công
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pagination for subjects -->
                            <div ng-if="allSubjects.length > subjectsPageSize" class="custom-pagination">
                                <button class="pagination-btn" 
                                        ng-click="previousSubjectsPage()" 
                                        ng-disabled="subjectsCurrentPage === 1">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                
                                <button ng-if="getSubjectsPages()[0] > 1" 
                                        class="pagination-btn" 
                                        ng-click="goToSubjectsPage(1)">
                                    1
                                </button>
                                
                                <span ng-if="getSubjectsPages()[0] > 2" class="pagination-dots">...</span>
                                
                                <button ng-repeat="page in getSubjectsPages()" 
                                        class="pagination-btn" 
                                        ng-class="{'active': page === subjectsCurrentPage}"
                                        ng-click="goToSubjectsPage(page)">
                                    {{page}}
                                </button>
                                
                                <span ng-if="getSubjectsPages()[getSubjectsPages().length - 1] < subjectsTotalPages - 1" 
                                      class="pagination-dots">...</span>
                                
                                <button ng-if="getSubjectsPages()[getSubjectsPages().length - 1] < subjectsTotalPages" 
                                        class="pagination-btn" 
                                        ng-click="goToSubjectsPage(subjectsTotalPages)">
                                    {{subjectsTotalPages}}
                                </button>
                                
                                <button class="pagination-btn" 
                                        ng-click="nextSubjectsPage()" 
                                        ng-disabled="subjectsCurrentPage === subjectsTotalPages">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                
                                <div class="pagination-info">
                                    Trang {{subjectsCurrentPage}} / {{subjectsTotalPages}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications Container -->
<toast-container></toast-container>

<!-- Modal Overlay - Chỉ hiện khi có modal active -->
<div id="modal-overlay" class="modal-overlay" style="display: none;"></div>

<!-- Avatar Modal -->
<div ng-include="'views/partials/avatar-modal.html'"></div>

<!-- Modal: Lecturer Form -->
<div class="modal" id="lecturerModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-chalkboard-teacher"></i> 
                    {{lecturerForm.lecturerId ? 'Cập nhật Giảng viên' : 'Thêm Giảng viên mới'}}
                </h5>
                <button type="button" class="modal-close" onclick="ModalUtils.close('lecturerModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form name="formLecturer" novalidate>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Họ tên <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" ng-model="lecturerForm.fullName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" ng-model="lecturerForm.email" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Bộ môn <span class="text-danger">*</span></label>
                                <select class="form-control" ng-model="lecturerForm.departmentId" required>
                                    <option value="">-- Chọn Bộ môn --</option>
                                    <option ng-repeat="d in departments" value="{{d.departmentId}}">
                                        {{d.departmentName}} ({{d.facultyName}})
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Chức vụ</label>
                                <input type="text" class="form-control" ng-model="lecturerForm.position" 
                                       placeholder="VD: Trưởng bộ môn">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Học hàm</label>
                                <input type="text" class="form-control" ng-model="lecturerForm.academicTitle" 
                                       placeholder="VD: GS., PGS., TS.">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Học vị</label>
                                <input type="text" class="form-control" ng-model="lecturerForm.degree" 
                                       placeholder="VD: Tiến sĩ, Thạc sĩ">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Chuyên môn</label>
                        <input type="text" class="form-control" ng-model="lecturerForm.specialization" 
                               placeholder="VD: Phát triển phần mềm">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="ModalUtils.close('lecturerModal')">Hủy</button>
                <button type="button" class="btn btn-primary" ng-click="saveLecturer()">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Assign Subjects -->
<div class="modal" id="assignSubjectsModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 14px 14px 0 0; position: relative;">
                <div>
                    <h5 class="modal-title" style="margin: 0; font-size: 20px; font-weight: 600;">
                        <i class="fas fa-book-reader"></i> Phân môn giảng dạy
                    </h5>
                    <p style="margin: 4px 0 0 0; font-size: 14px; opacity: 0.9;">
                        Giảng viên: <strong>{{selectedLecturer.fullName}}</strong>
                    </p>
                </div>
                <button type="button" class="modal-close" onclick="ModalUtils.close('assignSubjectsModal')" title="Đóng">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Body -->
            <div class="modal-body" style="padding: 20px 0; background: #f8fafc;">
                <div class="row" style="margin: 0 20px;">
                    <!-- LEFT: Môn đã được phân -->
                    <div class="col-md-8" style="padding-right: 10px;">
                        <div class="subject-section">
                            <div class="section-header">
                                <i class="fas fa-check-circle"></i>
                                <h6>Môn đã được phân</h6>
                                <span class="badge" style="background: #10b981; color: white; margin-left: 8px;">
                                    {{lecturerSubjects.length}} môn
                                </span>
                            </div>
                            
                            <div class="assigned-subjects-list">
                                <!-- Có môn -->
                                <div ng-if="lecturerSubjects.length > 0" class="subjects-grid">
                                    <div class="subject-card" ng-repeat="ls in lecturerSubjects">
                                        <div class="subject-card-header">
                                            <div class="subject-info">
                                                <div class="subject-code">{{ls.subjectCode}}</div>
                                                <div class="subject-name">{{ls.subjectName}}</div>
                                            </div>
                                            <button class="remove-btn" ng-click="removeSubject(ls.lecturerSubjectId)" 
                                                    title="Xóa môn này">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                        <div class="subject-card-footer" ng-if="ls.isPrimary || ls.experienceYears">
                                            <span class="primary-badge" ng-if="ls.isPrimary">
                                                <i class="fas fa-star"></i> Môn chủ nhiệm
                                            </span>
                                            <span class="exp-badge" ng-if="ls.experienceYears">
                                                <i class="fas fa-clock"></i> {{ls.experienceYears}} năm
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Chưa có môn -->
                                <div ng-if="lecturerSubjects.length === 0" class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>Chưa có môn học nào được phân</p>
                                    <small>Thêm môn học từ form bên phải</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RIGHT: Thêm môn mới -->
                    <div class="col-md-4" style="padding-left: 10px;">
                        <div class="subject-section">
                            <div class="section-header">
                                <i class="fas fa-plus-circle"></i>
                                <h6>Thêm môn mới</h6>
                            </div>
                            
                            <form name="formAssignSubject" class="add-subject-form">
                                <!-- Chọn môn học -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-book"></i> Môn học <span class="required">*</span>
                                    </label>
                                    <select class="form-control modern-select" ng-model="newSubject.subjectId" required>
                                        <option value="">-- Chọn môn học --</option>
                                        <option ng-repeat="s in availableSubjects" value="{{s.subjectId}}">
                                            {{s.subjectCode}} - {{s.subjectName}} ({{s.credits}} TC)
                                        </option>
                                    </select>
                                    <small class="form-help" ng-if="availableSubjects.length === 0">
                                        Không còn môn nào để thêm
                                    </small>
                                </div>
                                
                                <!-- Ghi chú -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-sticky-note"></i> Ghi chú
                                    </label>
                                    <textarea class="form-control" 
                                              ng-model="newSubject.notes" 
                                              rows="2"
                                              placeholder="Thêm ghi chú (không bắt buộc)..."></textarea>
                                </div>
                                
                                <!-- Button thêm -->
                                <button type="button" 
                                        class="btn btn-success btn-block btn-add-subject" 
                                        ng-click="addSubjectToLecturer()"
                                        ng-disabled="!newSubject.subjectId">
                                    <i class="fas fa-plus-circle"></i> Thêm môn học
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="modal-footer" style="background: #f8fafc; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" onclick="ModalUtils.close('assignSubjectsModal')">
                    <i class="fas fa-times"></i> Đóng
                </button>
            </div>
        </div>
    </div>
</div>

